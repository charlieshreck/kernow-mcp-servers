---
# Knowledge MCP - Consolidated semantic search, graph, wiki, and task management
# Replaces: knowledge-mcp, neo4j-mcp, outline-mcp, vikunja-mcp
apiVersion: v1
kind: ConfigMap
metadata:
  name: knowledge-mcp-config
  namespace: ai-platform
  labels:
    app: knowledge-mcp
    component: mcp
data:
  # Qdrant
  QDRANT_URL: "http://qdrant.ai-platform.svc.cluster.local:6333"
  OLLAMA_URL: "http://ollama.ai-platform.svc.cluster.local:11434"
  EMBEDDING_MODEL: "nomic-embed-text"
  # Neo4j
  NEO4J_URL: "http://neo4j.ai-platform.svc.cluster.local:7474"
  NEO4J_USER: "neo4j"
  # Vikunja
  VIKUNJA_URL: "http://vikunja.vikunja.svc.cluster.local:8080"
  # Outline
  OUTLINE_URL: "http://outline.ai-platform.svc.cluster.local"
  # Silver Bullet
  SILVERBULLET_URL: "http://silverbullet.ai-platform.svc.cluster.local:3000"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: knowledge-mcp
  namespace: ai-platform
  labels:
    app: knowledge-mcp
    component: mcp
    app.kubernetes.io/part-of: mcp-servers
spec:
  replicas: 1
  selector:
    matchLabels:
      app: knowledge-mcp
  template:
    metadata:
      labels:
        app: knowledge-mcp
        component: mcp
    spec:
      containers:
        - name: mcp-server
          image: ghcr.io/charlieshreck/mcp-knowledge:latest
          ports:
            - containerPort: 8000
              name: http
          envFrom:
            - configMapRef:
                name: knowledge-mcp-config
          env:
            - name: NEO4J_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: neo4j-credentials
                  key: NEO4J_PASSWORD
                  optional: true
            - name: VIKUNJA_API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: mcp-vikunja
                  key: API_TOKEN
                  optional: true
            - name: OUTLINE_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mcp-outline
                  key: API_KEY
                  optional: true
            - name: QDRANT_API_KEY
              valueFrom:
                secretKeyRef:
                  name: qdrant-api-key
                  key: QDRANT_API_KEY
                  optional: true
            - name: SILVERBULLET_USER
              valueFrom:
                secretKeyRef:
                  name: silverbullet-credentials
                  key: SB_USER
                  optional: true
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "500m"
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 30
---
apiVersion: v1
kind: Service
metadata:
  name: knowledge-mcp
  namespace: ai-platform
  labels:
    app: knowledge-mcp
spec:
  type: NodePort
  ports:
    - port: 8000
      targetPort: 8000
      nodePort: 31125  # Consolidated knowledge MCP (new port)
      name: http
  selector:
    app: knowledge-mcp
---
# Ingress for DNS-based access
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: knowledge-mcp
  namespace: ai-platform
  labels:
    app: knowledge-mcp
    component: mcp
spec:
  ingressClassName: traefik
  rules:
    - host: knowledge-mcp.agentic.kernow.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: knowledge-mcp
                port:
                  number: 8000
