# Home MCP - Consolidated smart home, network, and IoT management
# Combines: home-assistant-mcp, tasmota-mcp, unifi-mcp, adguard-mcp, homepage-mcp
# Endpoint: home-mcp.agentic.kernow.io
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: home-mcp
  namespace: ai-platform
  labels:
    app: home-mcp
    component: mcp
    domain: home
spec:
  replicas: 1
  selector:
    matchLabels:
      app: home-mcp
  template:
    metadata:
      labels:
        app: home-mcp
        component: mcp
        domain: home
    spec:
      containers:
        - name: home-mcp
          image: ghcr.io/charlieshreck/mcp-home:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8000
              name: http
          env:
            # Server config
            - name: PORT
              value: "8000"
            - name: HOST
              value: "0.0.0.0"
            # Home Assistant
            - name: HA_URL
              value: "https://homeassistant.kernow.io"
            - name: HA_TOKEN
              valueFrom:
                secretKeyRef:
                  name: mcp-homeassistant
                  key: API_KEY
            # UniFi (uses username/password auth)
            - name: UNIFI_HOST
              value: "https://10.10.0.51:11443"
            - name: UNIFI_USER
              valueFrom:
                secretKeyRef:
                  name: mcp-unifi
                  key: USERNAME
            - name: UNIFI_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mcp-unifi
                  key: PASSWORD
            - name: UNIFI_SITE
              value: "default"
            # AdGuard
            - name: ADGUARD_HOST
              value: "http://10.10.0.1:3000"
            - name: ADGUARD_USER
              valueFrom:
                secretKeyRef:
                  name: mcp-adguard
                  key: username
            - name: ADGUARD_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mcp-adguard
                  key: password
            # Tasmota
            - name: TASMOTA_DEVICES_FILE
              value: "/data/tasmota-devices.json"
            - name: TASMOTA_COMMAND_TIMEOUT
              value: "10.0"
            # Homepage (external URL - Homepage is in prod cluster)
            - name: HOMEPAGE_HOST
              value: "https://homepage.kernow.io"
            # Tasmota devices (pre-seeded from network scan)
            - name: TASMOTA_DEVICES
              value: "10.10.0.191,10.10.0.192,10.10.0.193,10.10.0.195,10.10.0.204,10.10.0.209,10.10.0.228,10.10.0.230,10.10.0.231,10.10.0.232,10.10.0.233,10.10.0.234,10.10.0.235,10.10.0.236,10.10.0.237,10.10.0.238,10.10.0.239,10.10.0.240,10.10.0.241,10.10.0.243,10.10.0.244,10.10.0.245,10.10.0.246,10.10.0.247,10.10.0.248,10.10.0.249"
          volumeMounts:
            - name: tasmota-data
              mountPath: /data
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "1000m"
          readinessProbe:
            httpGet:
              path: /ready
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
      volumes:
        - name: tasmota-data
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: home-mcp
  namespace: ai-platform
  labels:
    app: home-mcp
    component: mcp
    domain: home
spec:
  type: NodePort
  selector:
    app: home-mcp
  ports:
    - port: 8000
      targetPort: 8000
      nodePort: 31124
      name: http
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: home-mcp
  namespace: ai-platform
  labels:
    app: home-mcp
    component: mcp
spec:
  ingressClassName: traefik
  rules:
    - host: home-mcp.agentic.kernow.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: home-mcp
                port:
                  number: 8000
